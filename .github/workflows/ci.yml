name: CI

on:
  push:
    branches:
      - "**"
  pull_request:

jobs:
  quality-and-performance:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Setup Chrome
        id: chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install dependencies (root)
        run: bun install --frozen-lockfile

      - name: Install dependencies (app)
        run: |
          cd apps/bedrock-template
          bun install --frozen-lockfile
          cd ../astro-blog-template
          bun install --frozen-lockfile

      - name: Root quality gates
        run: bun run ci:root

      - name: App quality gates
        run: bun run ci:app

      - name: Lighthouse report (head)
        env:
          CHROME_PATH: ${{ steps.chrome.outputs.chrome-path }}
        run: |
          bun run perf:lighthouse -- --app-dir apps/bedrock-template --skip-build --output artifacts/lighthouse/head.json

      - name: Compute baseline commit
        id: baseline
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA=""

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            BASE_SHA="$(git merge-base HEAD "origin/${{ github.base_ref }}")"
          elif git rev-parse --verify HEAD^ >/dev/null 2>&1; then
            BASE_SHA="$(git rev-parse HEAD^)"
          fi

          echo "base_sha=${BASE_SHA}" >> "$GITHUB_OUTPUT"

      - name: Lighthouse report (baseline)
        if: steps.baseline.outputs.base_sha != ''
        env:
          CHROME_PATH: ${{ steps.chrome.outputs.chrome-path }}
        run: |
          set -euo pipefail

          BASE_DIR="${RUNNER_TEMP}/scryai-base"
          git worktree add "${BASE_DIR}" "${{ steps.baseline.outputs.base_sha }}"

          cd "${BASE_DIR}"
          bun install --frozen-lockfile
          cd apps/bedrock-template
          bun install --frozen-lockfile
          cd ../astro-blog-template
          bun install --frozen-lockfile
          cd "${BASE_DIR}"

          bun run perf:lighthouse -- --app-dir apps/bedrock-template --output "${GITHUB_WORKSPACE}/artifacts/lighthouse/base.json"

      - name: Assert Lighthouse thresholds + deltas
        if: steps.baseline.outputs.base_sha != ''
        run: |
          bun run perf:lighthouse:assert -- --report artifacts/lighthouse/head.json --baseline artifacts/lighthouse/base.json

      - name: Assert Lighthouse thresholds (no baseline)
        if: steps.baseline.outputs.base_sha == ''
        run: |
          bun run perf:lighthouse:assert -- --report artifacts/lighthouse/head.json

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: artifacts/lighthouse/*.json
